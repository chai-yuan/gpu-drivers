TOP_DIR      := $(CURDIR)
BUILD_ROOT   := $(TOP_DIR)/build

# --- Demos é…ç½® ---
DEMOS_SRC    := $(TOP_DIR)/demos
DEMOS_BUILD  := $(BUILD_ROOT)/demos
DEMOS_OPTS   := \
	-Dbuildtype=debug \
	-Dx11=enabled	\
	-Degl=enabled	\
	-Dlibdrm=enabled \
	-Dvulkan=disabled

# --- Kmscube é…ç½® ---
KMSCUBE_SRC    := $(TOP_DIR)/kmscube
KMSCUBE_BUILD  := $(BUILD_ROOT)/kmscube
KMSCUBE_OPTS   := \
	-Dbuildtype=debug

.PHONY: all demos kmscube clean help

# é»˜è®¤æ„å»ºæ‰€æœ‰
all: demos kmscube

# --- æ„å»º Demos ---
demos: $(DEMOS_BUILD)/build.ninja
	@echo "=== ğŸ—ï¸  æ­£åœ¨æ„å»º Mesa Demos ==="
	@meson compile -C $(DEMOS_BUILD)
	@echo "âœ… Demos æ„å»ºå®Œæˆ. ä½äº: $(DEMOS_BUILD)/src/demos/"

$(DEMOS_BUILD)/build.ninja: $(DEMOS_SRC)/meson.build
	@echo "--- âš™ï¸  æ­£åœ¨é…ç½® Demos (Meson) ---"
	@mkdir -p $(DEMOS_BUILD)
	@meson setup $(DEMOS_BUILD) $(DEMOS_SRC) $(DEMOS_OPTS)

# --- æ„å»º Kmscube ---
kmscube: $(KMSCUBE_BUILD)/build.ninja
	@echo "=== ğŸ—ï¸  æ­£åœ¨æ„å»º Kmscube ==="
	@meson compile -C $(KMSCUBE_BUILD)
	@echo "âœ… Kmscube æ„å»ºå®Œæˆ. ä½äº: $(KMSCUBE_BUILD)/"

$(KMSCUBE_BUILD)/build.ninja: $(KMSCUBE_SRC)/meson.build
	@echo "--- âš™ï¸  æ­£åœ¨é…ç½® Kmscube (Meson) ---"
	@mkdir -p $(KMSCUBE_BUILD)
	@meson setup $(KMSCUBE_BUILD) $(KMSCUBE_SRC) $(KMSCUBE_OPTS)

run-gears: demos
	$(DEMOS_BUILD)/src/demos/gears

run-kmscube: kmscube
	$(KMSCUBE_BUILD)/kmscube

# --- æ¸…ç† ---
clean:
	@echo "--- ğŸ§¹ æ­£åœ¨æ¸…ç†æ‰€æœ‰æ„å»ºç›®å½• ---"
	@rm -rf $(BUILD_ROOT)
	@echo "æ¸…ç†å®Œæˆã€‚"
